<div class="project-create-container">
  <div class="header">
    <h1>Create New Project</h1>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="loading$ | async" class="loading-overlay">
    <mat-spinner></mat-spinner>
    <p>Creating project...</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="error$ | async as error" class="error-message">
    <mat-icon>error</mat-icon>
    <div class="error-content">
      <span class="error-text">{{ error }}</span>
      <button
        (click)="createProject()"
        *ngIf="projectForm.valid"
        class="retry-button"
        color="primary"
        mat-button
      >
        <mat-icon>refresh</mat-icon>
        Retry
      </button>
    </div>
  </div>

  <form
    (ngSubmit)="createProject()"
    [formGroup]="projectForm"
    class="project-form"
  >
    <!-- Step 1: Project Type Selection -->
    <section class="form-section">
      <h2>Step 1: Select Project Type</h2>
      <div class="project-types">
        <mat-card
          (click)="onTypeSelect(typeOption.type)"
          *ngFor="let typeOption of projectTypes"
          [attr.aria-disabled]="!typeOption.enabled"
          [attr.aria-label]="typeOption.type + ' project type'"
          [class.disabled]="!typeOption.enabled"
          [class.selected]="isTypeSelected(typeOption.type)"
          class="type-card"
        >
          <mat-card-header>
            <mat-icon [class.disabled-icon]="!typeOption.enabled"
              >{{ typeOption.icon }}
            </mat-icon>
            <mat-card-title>{{ typeOption.type }}</mat-card-title>
          </mat-card-header>

          <mat-card-content>
            <p>{{ typeOption.description }}</p>
            <span *ngIf="!typeOption.enabled" class="coming-soon"
              >Coming Soon</span
            >
          </mat-card-content>

          <div
            *ngIf="isTypeSelected(typeOption.type)"
            class="selected-indicator"
          >
            <mat-icon>check_circle</mat-icon>
          </div>
        </mat-card>
      </div>

      <div
        *ngIf="
          projectForm.get('type')?.invalid && projectForm.get('type')?.touched
        "
        class="validation-error"
      >
        <mat-icon>warning</mat-icon>
        <span>Please select a project type</span>
      </div>
    </section>

    <!-- Step 2: Project Name -->
    <section class="form-section">
      <h2>Step 2: Configure Your Project</h2>
      <div class="form-row">
        <mat-form-field appearance="fill" class="half-width">
          <mat-label>Project Name</mat-label>
          <input
            aria-label="Project name input"
            formControlName="name"
            matInput
            placeholder="Enter a unique project name"
            required
          />
          <mat-hint>Mandatory: Specify a custom project name</mat-hint>
          <mat-error *ngIf="projectForm.get('name')?.hasError('required')">
            Project name is required
          </mat-error>
          <mat-error *ngIf="projectForm.get('name')?.hasError('minlength')">
            Project name must be at least 1 character
          </mat-error>
        </mat-form-field>
        <mat-form-field appearance="fill" class="half-width">
          <mat-label>Model Name</mat-label>
          <mat-select
            aria-label="Model name select"
            formControlName="modelName"
            placeholder="Select model"
          >
            <mat-option [value]="null">-- No Model --</mat-option>
            <mat-option *ngFor="let model of availableModels" [value]="model">
              {{ model }}
            </mat-option>
          </mat-select>
          <mat-hint>Specify the model name in databricks</mat-hint>
        </mat-form-field>
      </div>
      <div class="form-row">
        <mat-form-field appearance="fill" class="half-width">
          <mat-label>Group</mat-label>
          <mat-select
            aria-label="Group name select"
            formControlName="groupName"
            placeholder="Select group"
          >
            <mat-option [value]="null">-- No Group --</mat-option>
            <mat-option *ngFor="let group of availableGroups" [value]="group">
              {{ group }}
            </mat-option>
          </mat-select>
          <mat-hint>Optional: Assign project to a group</mat-hint>
        </mat-form-field>
      </div>
    </section>

    <!-- Step 3: Upload Images -->
    <section class="form-section">
      <h2>Step 3: Upload Training Images (Optional)</h2>
      <p class="section-description">
        Upload images in PNG, JPG, or JPEG format. You can also add images
        later.
      </p>

      <!-- File Validation Error -->
      <div
        *ngIf="fileValidationError"
        class="validation-error file-validation-error"
      >
        <mat-icon>warning</mat-icon>
        <span>{{ fileValidationError }}</span>
      </div>

      <!-- File Drop Zone -->
      <div
        (dragover)="onDragOver($event)"
        (drop)="onFileDrop($event)"
        [class.has-files]="selectedFiles.length > 0"
        class="drop-zone"
      >
        <mat-icon class="upload-icon">cloud_upload</mat-icon>
        <p class="drop-text">Drag and drop images here</p>
        <p class="drop-text-or">or</p>

        <label class="file-input-label" for="file-input">
          <button
            (click)="fileInput.click()"
            color="primary"
            mat-raised-button
            type="button"
          >
            <mat-icon>add_photo_alternate</mat-icon>
            Browse Files
          </button>
        </label>

        <input
          #fileInput
          (change)="onFileSelect($event)"
          accept=".png,.jpg,.jpeg"
          aria-label="File upload input"
          class="file-input"
          id="file-input"
          multiple
          type="file"
        />

        <p class="file-format-hint">
          Supported formats: PNG, JPG, JPEG (Max 10MB per file)
        </p>
      </div>

      <!-- Selected Files List -->
      <div *ngIf="selectedFiles.length > 0" class="selected-files">
        <h3>Selected Files ({{ selectedFiles.length }})</h3>
        <div class="files-list">
          <mat-card
            *ngFor="let file of selectedFiles; let i = index"
            class="file-item"
          >
            <div class="file-info">
              <mat-icon class="file-icon">image</mat-icon>
              <div class="file-details">
                <span class="file-name">{{ file.name }}</span>
                <span class="file-size">{{ formatFileSize(file.size) }}</span>
              </div>
            </div>
            <button
              (click)="removeFile(i)"
              [attr.aria-label]="'Remove ' + file.name"
              class="remove-button"
              mat-icon-button
              type="button"
            >
              <mat-icon>close</mat-icon>
            </button>
          </mat-card>
        </div>
      </div>
    </section>

    <!-- Action Buttons -->
    <section class="form-actions">
      <button
        (click)="cancel()"
        [disabled]="(loading$ | async) || false"
        mat-raised-button
        type="button"
        class="cancel-btn"
      >
        Cancel
      </button>

      <button
        [disabled]="projectForm.invalid || (loading$ | async) || false"
        color="primary"
        mat-raised-button
        type="submit"
      >
        <mat-icon>add</mat-icon>
        Create Project
      </button>
    </section>
  </form>
</div>
